<?xml version="1.0" encoding="UTF-8"?><record_update sys_domain="global" table="sys_script">
    <sys_script action="INSERT_OR_UPDATE">
        <abort_action>false</abort_action>
        <access>package_private</access>
        <action_delete>false</action_delete>
        <action_insert>false</action_insert>
        <action_query>false</action_query>
        <action_update>true</action_update>
        <active>true</active>
        <add_message>false</add_message>
        <advanced>true</advanced>
        <change_fields>false</change_fields>
        <client_callable>false</client_callable>
        <collection>x_vmw_cloudservice_register_cas_organization</collection>
        <condition/>
        <description/>
        <execute_function>false</execute_function>
        <filter_condition table="x_vmw_cloudservice_register_cas_organization">activeVALCHANGES^EQ<item endquery="false" field="active" goto="false" newquery="false" operator="VALCHANGES" or="false" value=""/>
            <item endquery="true" field="" goto="false" newquery="false" operator="=" or="false" value=""/>
        </filter_condition>
        <is_rest>false</is_rest>
        <message/>
        <name>vRACS_Activate_Deavtivate_VRA</name>
        <order>100</order>
        <priority>100</priority>
        <rest_method/>
        <rest_method_text/>
        <rest_service/>
        <rest_service_text/>
        <rest_variables/>
        <role_conditions/>
        <script><![CDATA[(function executeRule(current, previous /*null when async*/) 
{
	var appUtil = new CASAppUtil();
	
	
	try
		{
			CASLogger.debug("Inside vRACS_Activate_Deavtivate_VRA:Business Rule");
	if(current.active == true)
		{
			//var deployment = new vRACSActiveStatus();
			var updtData = new CASDaoUtil();
			
			
			
			//updtData.updateProjectActive(current);
			//code to activate the projectes related to existing end point.
			var grProj = new GlideRecord(appUtil.configuration.table.project);
			grProj.addQuery('organization',current.sys_id);
			grProj.query();
			while(grProj.next())
				{
					grProj.active = true;
					grProj.update();
				}
			//activate the Catalog items associated with End Point.
			var grCatlg = new GlideRecord(appUtil.configuration.table.catalogItem);
			grCatlg.addQuery('organisation_name', current.sys_id);
			grCatlg.query();
			while(grCatlg.next())
				{
					grCatlg.active = true;
					grCatlg.update();
				}
			
			//activate the Entitlements associated with End Points.
			var grEntmt = new GlideRecord(appUtil.configuration.table.entitlement);//entitlement
			grEntmt.addQuery('endpoint', current.sys_id);
			grEntmt.query();
			while(grEntmt.next())
				{
					grEntmt.active = true;
					grEntmt.update();
				}
			
			var grDeploym = new GlideRecord('x_vmw_cloudservice_deployments');
			grDeploym.addQuery('u_project.organization', current.sys_id);
			grDeploym.query();
			while(grDeploym.next())
				{
					grDeploym.operational_status = '1';
					grDeploym.update();
				}
			
			var grMachines = new GlideRecord('x_vmw_cloudservice_machines');
			grMachines.addQuery('project.organization', current.sys_id);
			grMachines.query();
			while(grMachines.next())
				{
					grMachines.operational_status = '1';
					grMachines.update();
				}			
		}
	else if(current.active == false)
		{
			//Deactivate the project associated with Endpoint
			
			
			var grPro = new GlideRecord(appUtil.configuration.table.project);
			grPro.addQuery('organization',current.sys_id);
			grPro.query();
			while(grPro.next())
				{
					grPro.active = false;
					grPro.update();
				}
			//Deactivate the Catalog items associated with endpoints
			var grCatlog = new GlideRecord(appUtil.configuration.table.catalogItem);
			grCatlog.addQuery('organisation_name', current.sys_id);
			grCatlog.query();
			while(grCatlog.next())
				{
					grCatlog.active = false;
					grCatlog.update();
				}
			
			//Deactivate the Entitlements associated with End Points.
			var grEntmnt = new GlideRecord(appUtil.configuration.table.entitlement);//entitlement
			grEntmnt.addQuery('endpoint', current.sys_id);
			grEntmnt.query();
			while(grEntmnt.next())
				{
					grEntmnt.active = false;
					grEntmnt.update();
				}
			
			//deactivate the Deployments associated with End Points. (Status change to "Retire ")
			var grDeploy = new GlideRecord('x_vmw_cloudservice_deployments');
			grDeploy.addQuery('u_project.organization', current.sys_id);
			grDeploy.query();
			while(grDeploy.next())
				{
					grDeploy.operational_status = '6';
					grDeploy.update();
				}
			
			
			//Deactivare the Machines associated with End Points. (Status change to "Retire ")	
			var grMachine = new GlideRecord('x_vmw_cloudservice_machines');
			grMachine.addQuery('project.organization', current.sys_id);//project.organization
			grMachine.query();
			while(grMachine.next())
				{
					grMachine.operational_status = '6';
					grMachine.update();
				}
			
		}
		}
	catch(e)
		{
			CASLogger.error("Exception caught inside vRACS_Activate_Deavtivate_VRA:Business Rule"+e);
		}
	
	
})(current, previous);]]></script>
        <sys_class_name>sys_script</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2019-08-26 09:47:27</sys_created_on>
        <sys_domain>global</sys_domain>
        <sys_domain_path>/</sys_domain_path>
        <sys_id>0dac1eb8db2733008d1b9235ca96192b</sys_id>
        <sys_mod_count>45</sys_mod_count>
        <sys_name>vRACS_Activate_Deavtivate_VRA</sys_name>
        <sys_overrides/>
        <sys_package display_value="VMware vRealize Automation ITSM Application 8.3" source="x_vmw_cloudservice">0d6a0ec1db11bb407c83712ebf96194d</sys_package>
        <sys_policy/>
        <sys_scope display_value="VMware vRealize Automation ITSM Application 8.3">0d6a0ec1db11bb407c83712ebf96194d</sys_scope>
        <sys_update_name>sys_script_0dac1eb8db2733008d1b9235ca96192b</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2020-02-07 09:59:28</sys_updated_on>
        <template/>
        <when>after</when>
    </sys_script>
    <sys_translated_text action="delete_multiple" query="documentkey=0dac1eb8db2733008d1b9235ca96192b"/>
</record_update>
