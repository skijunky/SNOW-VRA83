<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[function($scope, $filter,spUtil,$location) {
	var c = this;
	c.data.currentAction = {};

	//--------------------------------------selectAction method--------
	//USAGE: For for assigning user selected action from Actions Array
	//PARAMS: action--> object of selected action
	//VALUE: action--> OBJECT.
	$scope.selectAction = function(action,dep_sysID){
		c.data.day2FormWidget='';
		c.data.actionId=action.actionId;
		c.data.depSysId = dep_sysID;
		c.data.currentAction = action;
		//alert($scope.hasForm(action.label))
		if($scope.hasForm(action.label)){
			c.data.action='day2action';
			c.server.update().then(function(){
				c.data.action='';
			});
		}
	};
	
	$scope.redirect=function(url){
		//alert(url)
		$location.url(url);
	}
	
		$scope.$on('sp_loading_indicator', function(e, value) {
			c.data.loaderShow=value;
   });


	$scope.filterSearch = function(passedSearch) {
		var query = '';
		if (passedSearch != '') {
			query = 
				'nameLIKE' + passedSearch + '^NQ' +
				'short_descriptionLIKE' + passedSearch + '^NQ' +
				'statusLIKE' + passedSearch + '^NQ' +
				'u_projectLIKE' + passedSearch + '^NQ' +
				'vra_ownerLIKE' + passedSearch + '^NQ' +
				'expires_onLIKE' + passedSearch + '^NQ' +
				'created_atLIKE' + passedSearch + '^NQ';

		} 
		var passingObj={'query':query};
		$scope.$broadcast('setPaginationDataEvent', passingObj)
		if(query==''){
			$scope.redirect('?id=vra_deploymentspage')
		}
	}
	
	spUtil.recordWatch($scope,'x_vmw_cloudservice_vra_action_request','',function(name,data){
		c.data.action='updateJSON';
		c.server.update().then(function(){
			c.data.action='';
		})
	})

	$scope.$on("getPaginationDataEvent", function (evt, response) {
	//	console.log(response.itemsArray);
		c.data.cards = response.itemsArray;
		$scope.totalRecords = response.totalRecords;
		
	});

	//---------submitAction method-----------
	//USAGE: For for submitting action into action request table
	//PARAMS: reason--> reason entered by user
	//VALUE: reason--> STRING
	$scope.submitAction = function(reason) {
		c.data.reason = reason;
		c.data.action = 'submit';
		c.server.update().then(function(){
			$scope.redirect('?id=vra_deploymentspage')
		});
	}


	$scope.hasForm=function(label){
		if(label == 'Create Snapshot'||
			 label == 'Change Lease' ||
			 label == 'Add Disk'||
			 label == 'Remove Disk' ||
			 label == 'Update' ||
			 label=='Delete Snapshot' ||
			 label=='Resize' ||
			 label=='Revert To Snapshot'||
			label=='Resize Boot Disk'||
			label=='Resize Disk'){
			return true;
		}
		return false;
	}
}
]]></client_script>
        <controller_as>c</controller_as>
        <css>
.cas-content-area {
  padding-bottom: 0px;
}
.cas-clr-col-8 &gt; h2 {
  margin-top: 0;
  line-height: 1.475rem;
}

.header-tool-container {
  display: flex;
}
.loader-container {
  position: relative;
  z-index: 2000 !important;
  top:0;
  left:0;
  background-color: rgba(0,0,0,0);
  overflow: hidden;
  color:#ffffff;
  text-align:center;
}
.wdg-btn-link {
  //padding: 0 .4m;
  padding-left: .4rem;
  min-width: 30px;
  fill: #0078b8;
  &amp;:hover  {
    fill: #004d8a;
  }
}
.wdg-footer-wrapper{
  text-align: center;
  padding: 1rem;
  padding-top: 0;
}

.searchWrapper{
  width: calc(100% - 90px);
  float:left;
}
.toggleWrapper{
  // width:25%;
  // float:left;
}
.cas-disabled {
  fill: #565656;
  cursor: not-allowed;
  opacity: .4;
  background-color: transparent;
  border-color: transparent;
  -webkit-box-shadow: none;
  box-shadow: none;
  &amp;:hover {
    fill: #565656;
  }
}
.wdg-badge-count {
  vertical-align: middle;
}
.wdg-badge-close {
  margin-left: 4px;
}
.wdg-search {
  width: calc(100% - 1px);
}
.infinite-container {
  //padding: 1.1rem;
  padding-top: 0;
  height: calc(100vh - 157.4px); //60(Header) + 36(Navbar) + 26.4(1.1rem content padding) + 35(Content Header)
  overflow-y: auto;
  overflow-x: hidden;
}
.col-lg-3, .col-md-4, col-12 {
  padding: 0px 12px;
}
span[shape="search"] {
  margin: 3px;
}
span[shape="cas-logo"] {
  margin-right: 10px;
  vertical-align: top;
}

span[shape="success-standard"], span[shape="close-circle"], span[shape="info-standard"], span[shape="info-circle"] {
  vertical-align: text-bottom;
}

.wdg-desc {
  display: inline-block;
  overflow-x: hidden;
  width: calc(100% - 45px);
  a {
    font-size: 16px;
  }
  div {
    font-size: 12px;
  }
}

.wdg-desc.wdg-empty {
  color: #9a9a9a !important;
}


.wdg-value {
  font-weight: 500;
}

.wdg-action {
  position: absolute;
  right: 0;
  top: 6px;
}

.wdg-load-more-container {
  display: flex;
  justify-content: center;
  height: 2rem;
}
.empty-message-container {
  height: calc(100vh - 157.4px);
  display: flex;
  align-items: center;
  justify-content: center;
  span {
    span {
      display: inline-flex;
      margin: auto;
      position: relative;
      left: 50%;
      transform: translateX(-50%);
    }
  }
}
.cas-disabled {
  pointer-events: none;
}
.cas-modal-body {
  min-height: 20vh;
}

.cas-clr-textarea {
  width: 100%;
}

.wdg-dropdown {
  background: transparent;
  border: none;
  display: flex;
  align-items: center;
  padding: 0px;
  margin-bottom: -3px;
}
.dropdown-menu {
  padding: .5rem 0;
  background: #fff;
  border: 1px solid #ccc;
  border-radius: .125rem;
  box-shadow: 0 1px 0.125rem rgba(115,115,115,.25);
}
.cas-dropdown-item {
  a {
    color: #575757;
  }
  padding: .125rem 1rem;
  &amp;:hover {
    cursor:pointer;
    background-color: #ededed;
    color: #575757;
    text-decoration: none;
  }
}

.clearSearch{
  position:relative;
  right:15px;
}</css>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>false</has_preview>
        <id>cas_deploymentscard</id>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {
  
}]]></link>
        <name>CAS_deploymentsCard</name>
        <option_schema>[{"name":"page_window_size","section":"other","default_value":"20","label":"Page window size","type":"integer"}]</option_schema>
        <public>false</public>
        <roles>x_vmw_cloudservice.vra_catalog_admin,x_vmw_cloudservice.vra_end_user</roles>
        <script><![CDATA[(function() {
	try {
		CASLogger.debug('Inside CAS_deploymentsCard widget')
		var daoUtil = new CASDaoUtil();
		var appUtil = new CASAppUtil();
		var paramObject = {};
		paramObject.organizationSysId = $sp.getParameter('org_id') ? $sp.getParameter('org_id') : null;
		paramObject.projectSysId = $sp.getParameter('proj_id') ? $sp.getParameter('proj_id') : null;
		data.loaderShow=false;
		var paginationOptionSchema ;
		var urlPage = $sp.getParameter('id') || '';
		var organizationName = $sp.getParameter('org_name');
		var projectName = $sp.getParameter('proj_name');
		var catalogSysId = $sp.getParameter('catalogSysId');
		data.filterText='';
		data.cards=[];
		data.badgeLabel = '';
		data.headerTitle = 'Deployments';
		data.link = {
			list: '/'+gs.getProperty(appUtil.configuration.properties.portalPrefix)+'?id='+appUtil.configuration.page.deploymentList,
			card: '/'+gs.getProperty(appUtil.configuration.properties.portalPrefix)+'?id='+appUtil.configuration.page.deploymentCard,
			badgeLink: '/'+gs.getProperty(appUtil.configuration.properties.portalPrefix)+'?id=' + urlPage,
			additionalLink: '&proj_id=' + paramObject.projectSysId + '&org_id=' + paramObject.organizationSysId +'&list=false&showP=true'
		}
		if (projectName) {
			data.badgeLabel = projectName + ' (' + organizationName + ')';
		} 
		else if (organizationName) {
			data.badgeLabel = 'All (' + organizationName + ')';
		}

		//changes for the recordwatcher on Day2Action Request.
		if(input && input.action=='updateJSON'){
			data.mainJSON = daoUtil.fetchPortalDeploymentDetails({sysId: input.depSysId, machineSysId: $sp.getParameter('macSysId')}); 
			input.mainJSON=data.mainJSON;
		}
		
		var query ='';
		if (paramObject && paramObject.projectSysId) {
			query += 'u_project='+paramObject.projectSysId + '^';
		} else if (paramObject && paramObject.organizationSysId) {
			query += 'u_project.organization='+paramObject.organizationSysId + '^';
		}
		if (paramObject && paramObject.query) {
			query += paramObject.query;
		}
		
		var filter = $sp.getParameter('filter');
		//gs.addErrorMessage(filter);
		data.filterQuery=filter;
		if (filter) {
			if(filter=='expires_on!=NULL^ORDERBYexpires_on^expired=false'){
			query += '^'+filter;
			data.badgeLabel = 'Expiring Soon';
				
			}else{
			query += '^status=' + filter;
			data.badgeLabel = filter +'';
			}
		}
//gs.addErrorMessage('obj'+JSON.stringify(paramObject))
		data.cards = daoUtil.fetchPortalDeployments(paramObject);
		paginationOptionSchema = {
			catalogSysId : catalogSysId,
			windowSize: (options.page_window_size) ? options.page_window_size : 20,
			table:appUtil.configuration.table.deployments,
			method: 'fetchPortalDeployments',
			query: query,
			infiniteScroll: true
		}
		//gs.addErrorMessage(JSON.stringify())
		data.widgetScript = $sp.getWidget('cas_pagination', paginationOptionSchema);

		data.day2FormWidget='';
		if(input && input.action=='day2action'){
			//gs.addErrorMessage(input.actionId)
			data.actionId=input.actionId;
			var day2options={
				sysId:data.actionId,
				dep_sysId:input.depSysId+''
			};
			data.day2FormWidget = $sp.getWidget('cas_day2action_form',day2options);
		}
	

		if (input && input.action == 'submit') {
			data.reason = input.reason;
			data.currentAction = input.currentAction;
			var paramObj = {
				reason: data.reason,
				actionId: data.currentAction.actionId,
				state : 'Ready',
				deployment_id:input.depSysId+'',
				body: JSON.stringify({})
			}
			var response = daoUtil.createActionRequest(paramObj);
			if (response) {
				gs.addInfoMessage('Action submitted from portal');
			}
		}
	}catch (e) {
		CASLogger.error('Exception caught inside CAS_deploymentsCard widget: '+e);
	}	
})();]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>navdeep</sys_created_by>
        <sys_created_on>2019-08-14 07:18:05</sys_created_on>
        <sys_id>2f574089dbdb7300ff7c294648961981</sys_id>
        <sys_mod_count>653</sys_mod_count>
        <sys_name>CAS_deploymentsCard</sys_name>
        <sys_package display_value="VMware vRealize Automation ITSM Application 8.3" source="x_vmw_cloudservice">0d6a0ec1db11bb407c83712ebf96194d</sys_package>
        <sys_policy/>
        <sys_scope display_value="VMware vRealize Automation ITSM Application 8.3">0d6a0ec1db11bb407c83712ebf96194d</sys_scope>
        <sys_update_name>sp_widget_2f574089dbdb7300ff7c294648961981</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2020-05-14 13:04:24</sys_updated_on>
        <template><![CDATA[<div>
  <div class="cas-content-area">
    <div class="cas-clr-row">
      <div class="cas-clr-col-8">
        <h2>
          <span>{{c.data.headerTitle}}</span>
          <span class="cas-label cas-label-info wdg-badge-count">{{c.data.cards.length}} of {{totalRecords}} {{(totalRecords > 0) ? 'Items' : 'Item'}}</span>
          <span class="cas-label cas-label-light-blue wdg-badge-count" ng-if="c.data.badgeLabel != ''">{{c.data.badgeLabel}}<a href="{{c.data.link.badgeLink}}"><cas-clr-icon class="wdg-badge-close" shape="close" size="13"></cas-clr-icon></a></span>
        </h2>
      </div>
      <div class="cas-clr-col-4 header-tool-container" >
        <div class="cas-dropdown cas-open">
          <button ng-if="c.data.showFilter" class="cas-dropdown-toggle cas-btn cas-btn-sm cas-btn-link" onclick="$('.cas-dropdown-menu').toggle()">
            View My Activities
            <cas-clr-icon shape="angle" dir="down" color="#0077b7" size="12" role="none"></cas-clr-icon>
          </button>
          <div class="cas-dropdown-menu" style="display: none;">
            <a href="{{c.data.link.showMyFilterTrue}}"><div class="cas-dropdown-item">View My Activities</div></a>
            <a href="{{c.data.link.showMyFilterFalse}}"><div class="cas-dropdown-item">View All Activities</div></a>
          </div>
        </div>
        <cas-clr-icon size="16" shape="search"></cas-clr-icon>
        <input type="text" placeholder="Search" 
               class="wdg-search cas-clr-input"
               ng-model="c.data.filterText" 
               ng-model-options="{ debounce: 500 }" 
               ng-change="filterSearch(c.data.filterText)" />
        <span class="clearSearch" ng-show="c.data.filterText!=''" ng-click="filterSearch('');c.data.filterText='';"><i class="fa fa-times" aria-hidden="true"></i></span>


        <a class="wdg-btn-link cas-toggle-view" href="{{c.data.link.list}}&filter={{c.data.filterQuery}}">
          <cas-clr-icon shape="view-list" size="20" role="none"></cas-clr-icon>
        </a>
        <a class="wdg-btn-link cas-disabled" href="{{c.data.link.card}}&filter={{c.data.filterQuery}}">
          <cas-clr-icon shape="view-cards" size="20" role="none"></cas-clr-icon>
        </a>
      </div>
    </div>

    <div class="infinite-container" ng-show="c.data.cards.length">
      <div class="cas-clr-row">
        <div class="cas-clr-col-12">
          <div class="cas-clr-row " ng-repeat="card in c.data.cards | filter: {name : filterText}">
            <div class="cas-clr-col-12">
              <div class="cas-card">
                <div class="cas-card-block">
                  <div class="cas-card-text cas-clr-row">
                    <div class="cas-clr-col-4">
                      <cas-clr-icon shape="cas-logo" size="30" color="green" role="none"></cas-clr-icon>
                      <div class="wdg-desc">
                        <a href="{{card.link}}{{c.data.link.additionalLink}}">{{card.name}}</a>
                        <div>
                          {{(card.description == '-')? 'No Description' : card.description}}
                        </div>
                      </div>
                    </div>
                    <div class="cas-clr-col-4">
                      <div>Status:
                        <span ng-if="card.status == 'In Progress'" class="cas-spinner cas-spinner-inline"></span>
                        <cas-clr-icon ng-if="card.status == 'CREATE_FAILED'" shape="close-circle" size="17" color="red" class="is-success" role="none"></cas-clr-icon>
                        <cas-clr-icon ng-if="card.status == 'UPDATE_FAILED'" shape="info-circle" size="17" color="red" class="is-success" role="none"></cas-clr-icon>
                        <cas-clr-icon ng-if="card.status == 'CREATE_SUCCESSFUL'" shape="success-standard" size="17" color="green" class="is-success" role="none"></cas-clr-icon>
                        <cas-clr-icon ng-if="card.status == 'UPDATE_SUCCESSFUL'" shape="success-standard" size="17" color="green" class="is-success" role="none"></cas-clr-icon>
                        <cas-clr-icon ng-if="card.status == 'Powered Off'" shape="info-standard" size="17" color="orange" class="is-success" role="none"></cas-clr-icon>
                        <span class="wdg-value">{{card.status}}</span>
                      </div>
                      <div>Provisioned on: <span class="wdg-value">{{card.provisionedOn | date:"dd/MM/yyyy HH:mm:ss a"}}</span></div>
                      <div ng-if="card.expiresOn!=0">Expires on: <span class="wdg-value" ng-if="card.expiresOn!=0">{{card.expiresOn | date:"dd/MM/yyyy HH:mm:ss a"}}</span></div>
                    </div>
                    <div class="cas-clr-col-4">
                      <div>Resources: <span class="wdg-value">{{card.resources}}</span></div>
                      <div>Project: <span class="wdg-value">{{card.project}}</span></div>
                      <div>Owner: <span class="wdg-value">{{card.owner}}</span></div>
                    </div>
                  </div>
                  <div class="wdg-action">
                    <div class="dropdown cas-dropdown">
                      <button class="dropdown-toggle wdg-dropdown cas-dropdown-toggle cas-btn cas-btn-link" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <span class="cas-nav-text" style="color:{{c.data.json[0].color.text_color.color}}">Actions</span>
                      </button>
                      <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuButton">
                        <div class="cas-dropdown-item" ng-click="redirect(card.shareLink+'&order=12')"  ng-class="{'cas-disabled' : card.shareable=='false'}">
                          Share
                        </div>
                        <div class="cas-dropdown-item"
                             ng-repeat="action in card.actions" 
                             ng-click="selectAction(action,card.sysId)" 
                             ng-class="{'cas-disabled' : (!action.valid || (c.data.mainJSON.deploymentActionValid == false))}"
                             onclick="$('.action-modal, .action-modal-backdrop').show()" 
                             >
                         {{action.label}}
                        </div>
                      </div>
                    </div>
                    <!--
<div class="cas-dropdown wdg-deployment-action-cas-dropdown cas-bottom-right" onclick="toggleAction(this)">
<button class=  "cas-dropdown-toggle cas-btn cas-btn-link" type="button">
Actions
<cas-clr-icon shape="angle" size="10" color="#0077b7  dir="down" role="none"></cas-clr-icon>
</button>
<div class="cas-dropdown-menu">
<a href="{{card.shareLink}}&order=2" class="cas-dropdown-item">Share</a>
<button class="cas-dropdown-item" 
ng-click="selectAction(action)" 
ng-class="{'cas-disable d' : !action.valid}"
onclick="$('.action-modal, .action-modal-backdrop').show()" 
ng-repeat="action in card.actions">{{action.label}}</button>
</div>
</div>-->
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="cas-clr-row">
        <div class="cas-clr-col-12 wdg-load-more-container">
          <div class="cas-btn cas-btn-link wdg-load-more-container">
            <sp-widget widget="c.data.widgetScript"></sp-widget>
          </div>
        </div>
      </div>
    </div>
    <div class="empty-message-container" ng-if="!c.data.cards.length">
      <span><cas-clr-icon shape="sad-face" color="#717171" size="30"></cas-clr-icon>
        <p>No record found</p>
      </span>
    </div>
  </div>



  <!-----------------modal--------------------------->
  <div class="cas-modal action-modal" style="display: none">
    <div class="cas-modal-dialog" role="dialog" aria-hidden="true">
      <div class="cas-modal-content">
        <div class="cas-modal-header">
          <button aria-label="Close" class="cas-close" type="button" ng-click="c.data.reason=''" onclick="$('.cas-modal, .cas-modal-backdrop').hide() ">
            <cas-clr-icon aria-hidden="true" shape="close" color="#565656" size="25" role="none"></cas-clr-icon>
          </button>
          <h3 class="cas-modal-title">{{c.data.currentAction.label}}</h3>
        </div>
        <div class="cas-modal-body">
          <div ng-if="hasForm(c.data.currentAction.label)">
            
      <!-- == 'Create Snapshot' || c.data.currentAction.label == 'Change Lease' || c.data.currentAction.label == 'Add Disk'|| c.data.currentAction.label == 'Remove Disk' || c.data.currentAction.label == 'Update'">-->
           <div ng-if="data.day2FormWidget!=''">
             <sp-widget widget="data.day2FormWidget"/>
            </div> 
            <div class="loader-container" ng-if="c.data.loaderShow">
              <span class="cas-spinner loadtext">
                Loading...
              </span>
            </div>
          </div>
          <div ng-if="!(hasForm(c.data.currentAction.label))" >
                      <!--c.data.currentAction.hasForm && !(c.data.currentAction.label == 'Create Snapshot' || c.data.currentAction.label == 'Change Lease' || c.data.currentAction.label == 'Add Disk'|| c.data.currentAction.label == 'Remove Disk' || c.data.currentAction.label == 'Update')">-->
            <div>
                  Are you sure you want to {{c.data.currentAction.label}} ? 
                </div>
            <form class="cas-clr-form cas-clr-form-horizontal">
              <div class="cas-clr-form-control cas-no-margin">
                
                <label for="reason" class="cas-clr-control-label cas-clr-col-md-5">Reason</label>
                <div class="cas-clr-control-container cas-clr-col-md-7">
                  <div class="cas-clr-input-wrapper">
                    <textarea placeholder="Reason" ng-model="c.data.reason" class="cas-clr-textarea"></textarea>
                  </div>
                </div>
              </div>
            </form>
          </div>
        </div>
        <div class="cas-modal-footer"  ng-if="!(hasForm(c.data.currentAction.label))">
           <button class="cas-btn cas-btn-outline" type="button" onclick="$('.cas-modal, .cas-modal-backdrop').hide()" ng-click="c.data.reason=''">Cancel</button>
          <button class="cas-btn cas-btn-primary" type="button" ng-click="submitAction(c.data.reason);c.data.reason=''" onclick="$('.cas-modal, .cas-modal-backdrop').hide()">Submit</button>
        </div>
      </div>
    </div>
  </div>
  <div class="cas-modal-backdrop action-modal-backdrop" aria-hidden="true" style="display: none;"></div>
  <!-----------------modal ends here----------------->



  <script>
    function toggleAction (element) {
      if ($(element).hasClass('cas-open')) {
        $('.wdg-action .cas-dropdown').removeClass('cas-open');
      } else {
        $('.wdg-action .cas-dropdown').removeClass('cas-open');
        $(element).addClass('cas-open');
      }
    }
  </script>
]]></template>
    </sp_widget>
</record_update>
